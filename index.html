<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F-ray | AI 피부 분석 뷰어</title>
    <!-- Chosen Palette: Soft Greige & Muted Teal -->
    <!-- Application Structure Plan: This HTML sets up the foundational two-panel layout (sidebar and main viewer). The left panel is for patient search, photo lists, and now includes buttons for adding new patients and uploading images. The right panel displays selected photos and AI analysis results. This structure supports an intuitive workflow for medical professionals. -->
    <!-- Visualization & Content Choices: Placeholder text and a simple SVG icon are used for the initial viewer area. The layout uses Tailwind CSS for responsiveness. Image zoom and pan are implemented via CSS transform. Firebase Storage is integrated for image uploads, and Firebase Firestore is integrated for patient and photo metadata management. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #FDFBF8; }
        .sidebar-container { background-color: #F5F3F0; }
        .main-viewer-container { background-color: #ECEAE7; }
        .patient-list-item:hover, .photo-list-item:hover { background-color: #E0DFDC; }
        .patient-list-item.selected, .photo-list-item.selected { background-color: #DCEFEB; border-left: 4px solid #4CAF50; }
        .full-screen-viewer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1000; }
        .zoomable-image { transition: transform 0.1s ease-out; }
        .compare-choice-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1001;
            display: flex; justify-content: center; align-items: center;
        }
        .compare-choice-modal {
            background-color: white; padding: 24px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-align: center;
        }
        /* Cursor styles for dragging */
        .image-draggable { cursor: grab; }
        .image-draggable.dragging { cursor: grabbing; }
        .analysis-canvas { position: absolute; top: 0; left: 0; pointer-events: none; transform-origin: top left; }

        /* 웹 이미지 선택 모달 스타일 */
        .web-image-select-modal {
            background-color: white; 
            padding: 24px; 
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            text-align: center;
            width: 90%; /* 화면 너비의 90% */
            max-width: 600px; /* 최대 너비 제한 */
            max-height: 80vh; /* 화면 높이의 80% */
            overflow-y: auto; /* 내용이 넘치면 스크롤 */
            display: flex;
            flex-direction: column;
        }
        #storageImageList {
            flex-grow: 1; /* 남은 공간을 채우도록 설정 */
            overflow-y: auto; /* 이미지 목록 자체에 스크롤 적용 */
        }
        #storageImageList img {
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        #storageImageList img:hover {
            border-color: #4CAF50;
        }

        /* ... (기존 스타일) ... */

    .image-wrapper {
        position: relative; /* 드래그 오버/소스 피드백을 위해 필요 */
    }

    .dragging-source {
        opacity: 0.5;
        border: 2px dashed #4CAF50;
    }
    .drag-over {
        border: 2px solid #4CAF50;
        box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }
    </style>
</head>
<body class="bg-white text-gray-800">
    <div class="flex h-screen overflow-hidden">
        
        <!-- 왼쪽 사이드바 -->
        <aside id="sidebar" class="w-full md:w-1/3 lg:w-1/4 h-full flex flex-col sidebar-container border-r border-gray-200">
            <header class="p-4 border-b border-gray-200">
                <h1 class="text-xl font-bold text-gray-800">F-ray 분석 시스템</h1>
                <p class="text-sm text-gray-500">환자 검색 및 사진 목록</p>
            </header>

            <!-- 환자 검색 입력창 -->
            <div class="p-4 border-b border-gray-200">
                <input type="search" id="patientSearch" placeholder="환자 이름 검색..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4CAF50]">
            </div>

            <!-- 새롭게 추가된 불러오기 및 환자 추가 버튼 -->
            <div class="p-4 border-b border-gray-200 flex flex-col space-y-2">
                <button id="addPatientBtn" class="px-3 py-2 text-sm bg-[#4CAF50] text-white rounded-md hover:bg-[#388E3C]">새 환자 추가</button>
                <button id="uploadWebImageBtn" class="px-3 py-2 text-sm bg-[#E8F5E9] text-[#2E7D32] rounded-md hover:bg-[#DCEFEB]">웹에서 사진 불러오기</button>
                <button id="uploadLocalImageBtn" class="px-3 py-2 text-sm bg-[#E8F5E9] text-[#2E7D32] rounded-md hover:bg-[#DCEFEB]">PC에서 사진 불러오기</button>
            </div>
            <!-- 버튼 끝 -->

            <!-- 환자 목록 -->
            <div class="flex-grow overflow-y-auto">
                <ul id="patientList">
                    <!-- 환자 정보가 여기에 표시될 거예요 -->
                </ul>
            </div>
            
            <!-- 사진 목록 섹션 (처음엔 숨겨져 있어요) -->
            <div id="photoListSection" class="h-1/2 flex flex-col border-t border-gray-300 hidden">
                 <div class="p-4 border-b border-gray-200">
                    <h2 id="photoListHeader" class="text-lg font-semibold">사진 목록</h2>
                    <div class="flex space-x-2 mt-2">
                        <button data-filter="all" class="photo-mode-filter-btn flex-1 px-2 py-1 text-sm bg-[#4CAF50] text-white rounded-md">전체</button>
                        <button data-filter="F-ray" class="photo-mode-filter-btn flex-1 px-2 py-1 text-sm bg-gray-200 rounded-md">F-ray</button>
                        <button data-filter="Portrait" class="photo-mode-filter-btn flex-1 px-2 py-1 text-sm bg-gray-200 rounded-md">Portrait</button>
                        <button data-filter="UV" class="photo-mode-filter-btn flex-1 px-2 py-1 text-sm bg-gray-200 rounded-md">UV</button>
                    </div>
                    <!-- 날짜 필터 추가 -->
                    <div class="mt-4">
                        <label for="photoDateFilter" class="block text-sm font-medium text-gray-700 mb-1">촬영 날짜:</label>
                        <input type="date" id="photoDateFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4CAF50]">
                    </div>
                    <!-- 각도 필터 추가 -->
                    <div class="mt-2">
                        <label for="photoAngleFilter" class="block text-sm font-medium text-gray-700 mb-1">각도:</label>
                        <select id="photoAngleFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4CAF50]">
                            <option value="all">모든 각도</option>
                            <option value="C0">C0</option>
                            <option value="L30">L30</option>
                            <option value="R30">R30</option>
                            <option value="L45">L45</option>
                            <option value="R45">R45</option>
                            <!-- 필요에 따라 다른 각도 추가 -->
                        </select>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto p-2">
                    <ul id="photoList" class="space-y-2">
                        <!-- 사진 썸네일이 여기에 표시될 거예요 -->
                    </ul>
                </div>
            </div>
        </aside>

        <!-- 오른쪽 메인 뷰어 -->
        <main id="mainViewer" class="w-full md:w-2/3 lg:w-3/4 h-full flex flex-col main-viewer-container">
            <div id="viewerPlaceholder" class="flex-grow flex items-center justify-center">
                <div class="text-center text-gray-500">
                    <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.586.586a2 2 0 002.828 0L18 8m-6 6l-1.586 1.586a2 2 0 01-2.828 0L6 14"/></svg>
                    <h3 class="mt-2 text-lg font-medium">사진 뷰어</h3>
                    <p class="mt-1 text-sm">좌측에서 환자를 검색하고 사진을 선택해주세요.</p>
                </div>
            </div>

            <div id="imageViewer" class="flex-grow flex-col h-full hidden">
                <!-- 뷰어 헤더 -->
                <div class="flex justify-between items-center p-3 bg-white border-b border-gray-200 shadow-sm">
                     <div id="viewerPatientInfo">
                        <h2 id="viewerPatientName" class="text-xl font-bold"></h2>
                        <p id="viewerPhotoInfo" class="text-sm text-gray-600"></p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                         <button id="compareBtn" class="px-3 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">사진 비교</button>
                         <button id="analyzeBtn" class="px-3 py-2 text-sm bg-[#E8F5E9] text-[#2E7D32] rounded-md hover:bg-[#DCEFEB]">AI 분석</button>
                         <button id="zoomInBtn" class="px-3 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">확대 (+)</button>
                         <button id="zoomOutBtn" class="px-3 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">축소 (-)</button>
                         <button id="resetViewBtn" class="px-3 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">초기화</button>
                         <button id="fullScreenBtn" class="px-3 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">전체 화면</button>
                         <!-- 여기에 사진 삭제 버튼 추가 -->
                         <button id="deletePhotoBtn" class="px-3 py-2 text-sm bg-red-500 text-white rounded-md hover:bg-red-600">사진 삭제</button>
                    </div>
                </div>

                <!-- 이미지 및 분석 영역 -->
                <div class="flex-grow flex p-4 gap-4 overflow-hidden">
                    <div id="image-container" class="relative w-full h-full flex-grow flex items-center justify-center bg-black rounded-lg image-draggable">
    <div id="mainImageWrapper" class="flex-1 flex items-center justify-center h-full overflow-hidden image-wrapper">
        <img id="mainImage" src="" alt="메인 이미지" class="max-w-full max-h-full object-contain zoomable-image">
    </div>
    <div id="compareImageWrapper" class="flex-1 flex items-center justify-center h-full hidden overflow-hidden image-wrapper">
        <img id="compareImage" src="" alt="비교 이미지" class="max-w-full max-h-full object-contain zoomable-image">
    </div>
    <div id="tertiaryImageWrapper" class="flex-1 flex items-center justify-center h-full hidden overflow-hidden image-wrapper">
        <img id="tertiaryImage" src="" alt="세번째 이미지" class="max-w-full max-h-full object-contain zoomable-image">
    </div>
    <canvas id="analysisCanvas" class="analysis-canvas"></canvas>
</div>
                    
                    <!-- 분석 패널 (처음엔 숨겨져 있어요) -->
                    <div id="analysisPanel" class="w-64 flex-shrink-0 bg-white p-4 rounded-lg shadow-md hidden overflow-y-auto">
                        <h3 class="text-lg font-bold border-b pb-2 mb-4">AI 분석 결과</h3>
                        <div id="analysisContent"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 비교 선택 팝업 (처음엔 숨겨져 있어요) -->
    <div id="compareChoiceOverlay" class="compare-choice-overlay hidden">
        <div class="compare-choice-modal">
            <p class="text-lg font-semibold mb-4">몇 장의 사진을 비교하시겠습니까?</p>
            <div class="flex justify-center space-x-4">
                <button id="choose2PhotosBtn" class="px-4 py-2 bg-[#4CAF50] text-white rounded-md hover:bg-[#388E3C]">2장 비교</button>
                <button id="choose3PhotosBtn" class="px-4 py-2 bg-[#4CAF50] text-white rounded-md hover:bg-[#388E3C]">3장 비교</button>
            </div>
        </div>
    </div>

    <!-- 숨겨진 파일 선택 입력창 -->
    <input type="file" id="localFileInput" accept="image/*" class="hidden">

    <!-- 웹 이미지 선택 팝업 추가 -->
    <div id="webImageSelectOverlay" class="compare-choice-overlay hidden">
        <div class="web-image-select-modal">
            <h3 class="text-xl font-bold mb-4">웹 이미지 선택</h3>
            <p class="text-sm text-gray-600 mb-4">Firebase Storage의 'images' 폴더에서 사진을 선택하세요.</p>
            <div id="storageImageList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto max-h-[calc(80vh-150px)]">
                <!-- 이미지들이 여기에 동적으로 로드될 거예요 -->
                <p class="col-span-full text-center text-gray-500">이미지를 불러오는 중...</p>
            </div>
            <div class="flex justify-end mt-4">
                <button id="closeWebImageSelectModal" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">닫기</button>
            </div>
        </div>
    </div>

    <script type="module" src="script.js"></script>
</body>
</html>
