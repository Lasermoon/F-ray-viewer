<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F-ray | AI 피부 분석 뷰어</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 기본 글꼴 및 배경색 설정 */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #FDFBF8; }
        /* 사이드바 및 메인 뷰어 컨테이너 배경색 설정 */
        .sidebar-container { background-color: #F5F3F0; }
        .main-viewer-container { background-color: #ECEAE7; }
        /* 환자/사진 목록 아이템 호버 및 선택 시 스타일 */
        .patient-list-item:hover, .photo-list-item:hover { background-color: #E0DFDC; }
        .patient-list-item.selected, .photo-list-item.selected { background-color: #DCEFEB; border-left: 4px solid #4CAF50; } /* 선택 시 좌측에 포인트 색상 추가 */
        /* 사진 모드 필터 버튼 활성화 시 스타일 */
        .photo-mode-filter-btn.active {
            background-color: #4CAF50; /* Muted Teal */
            color: white;
        }
        /* 분석 캔버스 스타일: 이미지 위에 오버레이 됨 */
        .analysis-canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            pointer-events: none; /* 캔버스 클릭 이벤트를 통과시켜 아래 이미지 클릭 가능하게 함 */
            transform-origin: top left; 
            z-index: 5; /* 이미지와 UI 요소 사이에 위치 */
        }
        /* 전체 화면 뷰어 스타일 */
        .full-screen-viewer { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
            z-index: 1000; /* 다른 요소들 위에 표시 */
        }
        /* 확대/축소 가능한 이미지에 부드러운 전환 효과 추가 */
        .zoomable-image { transition: transform 0.1s ease-out; }
        /* 비교 선택 오버레이 스타일 */
        .compare-choice-overlay, .web-image-select-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* 반투명 배경 */
            display: flex; 
            justify-content: center; 
            align-items: center;
            z-index: 1001; /* 다른 모달 위에 표시 */
        }
        .web-image-select-overlay {
            z-index: 1002; /* 더 높은 z-index */
        }
        /* 모달 공통 스타일 */
        .compare-choice-modal, .web-image-select-modal {
            background-color: white; 
            padding: 24px; 
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            text-align: center;
        }
        .web-image-select-modal {
            width: 80%; 
            max-width: 600px; 
            max-height: 80%; 
            overflow-y: auto;
            display: flex; 
            flex-direction: column;
        }
        .storage-image-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 16px;
            padding: 16px;
            overflow-y: auto;
        }
        /* 이미지 드래그 커서 스타일 */
        .image-wrapper { cursor: grab; }
        .image-wrapper.dragging-source { opacity: 0.5; } /* 드래그 중인 원본 요소 투명하게 */
        .image-wrapper.drag-over { border: 2px dashed #4CAF50; } /* 드롭 대상에 테두리 표시 */
        /* 캔버스 팬/줌 시 커서 */
        .cursor-grabbing { cursor: grabbing !important; }
    </style>
</head>
<body class="bg-white text-gray-800">
    <div class="flex h-screen overflow-hidden">
        
        <!-- 좌측 사이드바 -->
        <aside id="sidebar" class="w-full md:w-1/3 lg:w-1/4 h-full flex flex-col sidebar-container border-r border-gray-200">
            <header class="p-4 border-b border-gray-200">
                <h1 class="text-xl font-bold text-gray-800">F-ray 분석 시스템</h1>
                <p class="text-sm text-gray-500">환자 검색 및 사진 목록</p>
            </header>

            <!-- 환자 검색 -->
            <div class="p-4 border-b border-gray-200">
                <input type="search" id="patientSearch" placeholder="환자 이름 검색..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4CAF50]">
            </div>

            <!-- 환자 목록 -->
            <div class="flex-grow overflow-y-auto">
                <ul id="patientList">
                    <!-- 환자 항목이 여기에 주입됩니다 -->
                </ul>
            </div>
            
            <!-- 액션 섹션 (새 환자, 업로드) -->
            <div class="p-4 border-t border-gray-200 space-y-2">
                <button id="addPatientBtn" class="w-full bg-[#4CAF50] text-white py-2 rounded-md hover:bg-[#388E3C] transition duration-200">새 환자 추가</button>
                <div class="flex space-x-2">
                    <button id="uploadLocalImageBtn" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-md hover:bg-gray-300 transition duration-200">PC에서 불러오기</button>
                    <input type="file" id="localFileInput" class="hidden" accept="image/*">
                    <button id="uploadWebImageBtn" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-md hover:bg-gray-300 transition duration-200">웹에서 불러오기</button>
                </div>
            </div>

            <!-- 사진 목록 섹션 -->
            <div id="photoListSection" class="h-1/2 flex flex-col border-t border-gray-300 hidden">
                 <div class="p-4 border-b border-gray-200">
                    <h2 id="photoListHeader" class="text-lg font-semibold">사진 목록</h2>
                    <div class="flex space-x-2 mt-2">
                        <button data-filter="all" class="photo-mode-filter-btn flex-1 px-2 py-1 text-sm bg-[#4CAF50] text-white rounded-md">전체</button>
                        <button data-filter="F-ray" class="photo-mode-filter-btn flex-1 px-2 py-1 text-sm bg-gray-200 rounded-md">F-ray</button>
                        <button data-filter="Portrait" class="photo-mode-filter-btn flex-1 px-2 py-1 text-sm bg-gray-200 rounded-md">Portrait</button>
                        <button data-filter="UV" class="photo-mode-filter-btn flex-1 px-2 py-1 text-sm bg-gray-200 rounded-md">UV</button>
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <input type="date" id="photoDateFilter" class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded-md">
                        <select id="photoAngleFilter" class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded-md">
                            <option value="all">모든 각도</option>
                            <option value="C0">C0 (정면)</option>
                            <option value="L30">L30 (좌 30도)</option>
                            <option value="R30">R30 (우 30도)</option>
                            <option value="L45">L45 (좌 45도)</option>
                            <option value="R45">R45 (우 45도)</option>
                            <option value="L60">L60 (좌 60도)</option>
                            <option value="R60">R60 (우 60도)</option>
                        </select>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto p-2">
                    <ul id="photoList" class="space-y-2">
                        <!-- 사진 썸네일이 여기에 주입됩니다 -->
                    </ul>
                </div>
                <div class="p-4 border-t border-gray-200">
                    <button id="deletePhotoBtn" class="w-full bg-red-500 text-white py-2 rounded-md hover:bg-red-600 transition duration-200">선택 사진 삭제</button>
                </div>
            </div>
        </aside>

        <!-- 우측 메인 뷰어 -->
        <main id="mainViewer" class="w-full md:w-2/3 lg:w-3/4 h-full flex flex-col main-viewer-container">
            <div id="viewerPlaceholder" class="flex-grow flex items-center justify-center">
                <div class="text-center text-gray-500">
                    <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.586.586a2 2 0 002.828 0L18 8m-6 6l-1.586 1.586a2 2 0 01-2.828 0L6 14"/></svg>
                    <h3 class="mt-2 text-lg font-medium">사진 뷰어</h3>
                    <p class="mt-1 text-sm">좌측에서 환자를 검색하고 사진을 선택해주세요.</p>
                </div>
            </div>

            <div id="imageViewer" class="flex-grow flex-col h-full hidden">
                <!-- 뷰어 헤더 -->
                <div class="flex justify-between items-center p-3 bg-white border-b border-gray-200 shadow-sm">
                     <div id="viewerPatientInfo">
                        <h2 id="viewerPatientName" class="text-xl font-bold"></h2>
                        <p id="viewerPhotoInfo" class="text-sm text-gray-600"></p>
                    </div>
                    <div class="flex space-x-2">
                         <button id="compareBtn" class="px-3 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300 transition duration-200">사진 비교</button>
                         <button id="analyzeBtn" class="px-3 py-2 text-sm bg-[#E8F5E9] text-[#2E7D32] rounded-md hover:bg-[#DCEFEB] transition duration-200">AI 분석</button>
                         <button id="zoomInBtn" class="px-3 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300 transition duration-200">확대 (+)</button>
                         <button id="zoomOutBtn" class="px-3 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300 transition duration-200">축소 (-)</button>
                         <button id="resetViewBtn" class="px-3 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300 transition duration-200">초기화</button>
                         <button id="fullScreenBtn" class="px-3 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300 transition duration-200">전체 화면</button>
                    </div>
                </div>

                <!-- 이미지 및 분석 영역 -->
                <div class="flex-grow flex p-4 gap-4 overflow-hidden">
                    <div id="image-container" class="relative w-full h-full flex-grow flex items-center justify-center bg-black rounded-lg image-wrapper">
                        <!-- 이미지 래퍼들 (비교 모드 시 정렬을 위함) -->
                        <div id="mainImageWrapper" class="flex-1 flex items-center justify-center h-full overflow-hidden">
                            <img id="mainImage" src="" class="max-w-full max-h-full object-contain zoomable-image">
                        </div>
                        <div id="compareImageWrapper" class="flex-1 flex items-center justify-center h-full hidden overflow-hidden">
                            <img id="compareImage" src="" class="max-w-full max-h-full object-contain zoomable-image">
                        </div>
                        <div id="tertiaryImageWrapper" class="flex-1 flex items-center justify-center h-full hidden overflow-hidden">
                            <img id="tertiaryImage" src="" class="max-w-full max-h-full object-contain zoomable-image">
                        </div>
                        <!-- AI 분석 결과 오버레이 캔버스 -->
                        <canvas id="analysisCanvas" class="analysis-canvas"></canvas>
                    </div>
                    
                    <!-- AI 분석 패널 -->
                    <div id="analysisPanel" class="w-64 flex-shrink-0 bg-white p-4 rounded-lg shadow-md hidden overflow-y-auto">
                        <h3 class="text-lg font-bold border-b pb-2 mb-4">AI 분석 결과</h3>
                        <div id="analysisContent"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 비교 사진 선택 오버레이 -->
    <div id="compareChoiceOverlay" class="compare-choice-overlay hidden">
        <div class="compare-choice-modal">
            <p class="text-lg font-semibold mb-4">몇 장의 사진을 비교하시겠습니까?</p>
            <div class="flex justify-center space-x-4">
                <button id="choose2PhotosBtn" class="px-4 py-2 bg-[#4CAF50] text-white rounded-md hover:bg-[#388E3C]">2장 비교</button>
                <button id="choose3PhotosBtn" class="px-4 py-2 bg-[#4CAF50] text-white rounded-md hover:bg-[#388E3C]">3장 비교</button>
            </div>
        </div>
    </div>

    <!-- 웹 이미지 선택 오버레이 -->
    <div id="webImageSelectOverlay" class="web-image-select-overlay hidden">
        <div class="web-image-select-modal">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">웹에서 사진 불러오기 (Firebase Storage)</h3>
                <button id="closeWebImageSelectModal" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div id="storageImageList" class="storage-image-list flex-grow">
                <!-- Storage에서 불러온 이미지가 여기에 로드됩니다 -->
            </div>
             <p class="text-sm text-gray-500 mt-4">파일 이름이 '이름_전화번호_촬영모드_각도_촬영일자.jpg' 형식이어야 합니다.</p>
        </div>
    </div>

    <!-- 외부 JavaScript 파일 연결 -->
    <script type="module" src="script.js"></script>
</body>
</html>
